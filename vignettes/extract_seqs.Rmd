---
title: "extract seqs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{extract seqs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(devtools)
devtools::load_all() 
#install("/Users/rof011/symportalfunctions")
#library(symportalfunctions)
```

# extract_seqs

Extracts sequences from "`seqs.absolute.abund_and_meta.txt`" in the `post_med_seqs` folder.

`extract_seqs(folder= "20220919T102058_esampayo", type="absolute", clade="C")`

-   `folder` = name of the [**main**]{.underline} folder for symportal \*
-   `type` = "absolute" or "relative" abundance
-   `clade` = vector of clade types to keep, can be single, e.g. clade="C", or multiple e.g. clade=c("C", "D")
-   `threshold` = threshold threshold to remove samples, `1000` by default
-   `drop_samples` = drop samples by named vector, e.g. c("H00B07", "H00B06"), or by one or more partial matches, e.g. c("07","B06") \*\*
-   `drop_seqs` = drop seqs by named vector, e.g. c("X2777817_G", "X2777816_G"), or by one or more partial matches, e.g. c("X2","OT") \*\*
-   `silent` = either `TRUE` or `FALSE`, show which samples were removed by name

### Notes:

\* the `folder` name should be [only]{.underline} the base folder. For example, the folder for the following location `("20220919T102058_esampayo/post_med_seqs/224_20220926T061917_DBV_20220926T133809.seqs.absolute.abund_and_meta.txt")` should be: `(folder="20220919T102058_esampayo"`). The function will locate the correct txt file (`"...seqs.absolute.abund_and_meta.txt"`) automatically.

\*\* both `drop_samples` and `drop_seqs` accept either full names or partial matches for seqs and samples. Be careful to specify the exact full sample name or it will filter by a partial match.

## extract_seqs examples

### i) get the absolute abundance of all sequences

```{r}

tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="absolute")

tmp[1:5,1:10] # show first 5 cols, 10 rows
```

### ii) get the absolute abundance of C and D sequences:

```{r}

#symportalfolder="/Users/rof011/symbiodinium/20220919T102058_esampayo"

tmp <- extract_seqs("/Users/rof011/symbiodinium/20220919T102058_esampayo", type="absolute", clade=c("C", "D"))

tmp[1:5,1:10] # show first 5 cols, 10 rows
```

### iii) get the relative abundance of C sequences:

```{r}
tmp <- extract_seqs("/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C")

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

### iv) remove samples with \<100 seqs in total:

The threshold threshold by default is 1000 seqs, changing it here manually will lower this threshold to 100 seqs

```{r}
tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C", threshold=100)

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

### iv) remove samples with \<100 seqs in total:

The threshold threshold by default is 1000 seqs, changing it here manually will lower this threshold to 100 seqs

```{r}
tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C", threshold=100)

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

### v) drop samples containing "OT" and "H18"

The threshold threshold by default is 1000 seqs, changing it here manually will lower this threshold to 100 seqs

```{r}
tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", drop_samples = c("OT", "H18"), silent=FALSE)

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

### vi) drop seqs containing "OT" and "H18"

The default setting is `silent=TRUE`, set to `FALSE` to print removed sample names below the threshold

```{r}
tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", drop_seqs=c("X", "G"), silent=FALSE)

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

### vi) drop seqs and samples, list removed names

The default setting is `silent=TRUE`, set to `FALSE` to print removed sample names below the threshold

```{r}
tmp <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", drop_seqs=c("X", "G"), drop_samples = c("OT", "H18"), silent=FALSE)

round(tmp[1:5,1:10],3) # show first 5 cols, 10 rows, round to 3 decimal places
```

## example: Plot stacked bar graph of sequences (ggplot)

To extract in a long format (like `pivot-longer`), use `extract_seqs_long`. It's identical to `extract_seqs`, just returns in a long rather than wide format.

```{r, fig.width=10, fig.height=7}
# extract seqs
plot_data <- extract_seqs_long(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C") 
  

ggplot() + theme_bw() +
  geom_bar(data=plot_data, aes(x = sample.ID, y = abundance, fill = seq.ID), color="black", 
           linewidth=0.2, stat = "identity", show.legend=FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## example: plot dendrogram with KM clusters

Second example: use `extract_seqs` with vegan to get dendrogram and clusters.

```{r, fig.width=8, fig.height=7}
cluster.C <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C", threshold=100) 

library(vegan)
library(tibble)

cluster.C.dist <- vegdist(cluster.C, method ="bray")
cluster.C.km <- cascadeKM(cluster.C.dist, 1, 10, iter = 5000)

cluster.C.km.grps <- as.data.frame(cluster.C.km[["partition"]]) %>% 
  rownames_to_column(var="sample.ID")

```

```{r, fig.width=10, fig.height=5}
library(dendextend)

cluster.C.km.grps <- as.data.frame(cluster.C.km[["partition"]]) %>% 
  rownames_to_column(var="sample.ID")

cluster.C.dend  <- as.dendrogram(hclust(cluster.C.dist, method = "complete")) %>% color_labels(., k = 6)
plot(cluster.C.dend, main="Postmed C sequences >100 seqs", ylab="Bray Curtis")

```

Now tune the noise with threshold:

```{r, fig.width=10, fig.height=5}
cluster.C <- extract_seqs(folder="/Users/rof011/symbiodinium/20220919T102058_esampayo", type="relative", clade="C", threshold=10000) 

cluster.C.dist <- vegdist(cluster.C, method ="bray")
cluster.C.km <- cascadeKM(cluster.C.dist, 1, 10, iter = 5000)

cluster.C.km.grps <- as.data.frame(cluster.C.km[["partition"]]) %>% 
  rownames_to_column(var="sample.ID")

cluster.C.dend <- as.dendrogram(hclust(cluster.C.dist, method = "complete")) %>% color_labels(., k = 6)
plot(cluster.C.dend, main="Postmed C sequences >10,000 seqs", ylab="Bray Curtis")

```
